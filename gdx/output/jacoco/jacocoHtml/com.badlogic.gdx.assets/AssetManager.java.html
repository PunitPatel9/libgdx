<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AssetManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gdx</a> &gt; <a href="index.source.html" class="el_package">com.badlogic.gdx.assets</a> &gt; <span class="el_source">AssetManager.java</span></div><h1>AssetManager.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright 2011 See AUTHORS file.
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *   http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/

package com.badlogic.gdx.assets;

import java.util.Stack;

import com.badlogic.gdx.Application;
import com.badlogic.gdx.assets.loaders.AssetLoader;
import com.badlogic.gdx.assets.loaders.BitmapFontLoader;
import com.badlogic.gdx.assets.loaders.CubemapLoader;
import com.badlogic.gdx.assets.loaders.FileHandleResolver;
import com.badlogic.gdx.assets.loaders.I18NBundleLoader;
import com.badlogic.gdx.assets.loaders.MusicLoader;
import com.badlogic.gdx.assets.loaders.ParticleEffectLoader;
import com.badlogic.gdx.assets.loaders.PixmapLoader;
import com.badlogic.gdx.assets.loaders.ShaderProgramLoader;
import com.badlogic.gdx.assets.loaders.SkinLoader;
import com.badlogic.gdx.assets.loaders.SoundLoader;
import com.badlogic.gdx.assets.loaders.TextureAtlasLoader;
import com.badlogic.gdx.assets.loaders.TextureLoader;
import com.badlogic.gdx.assets.loaders.resolvers.InternalFileHandleResolver;
import com.badlogic.gdx.audio.Music;
import com.badlogic.gdx.audio.Sound;
import com.badlogic.gdx.graphics.Cubemap;
import com.badlogic.gdx.graphics.Pixmap;
import com.badlogic.gdx.graphics.Texture;
import com.badlogic.gdx.graphics.g2d.BitmapFont;
import com.badlogic.gdx.graphics.g2d.ParticleEffect;
import com.badlogic.gdx.graphics.g2d.PolygonRegion;
import com.badlogic.gdx.graphics.g2d.PolygonRegionLoader;
import com.badlogic.gdx.graphics.g2d.TextureAtlas;
import com.badlogic.gdx.graphics.g3d.Model;
import com.badlogic.gdx.graphics.g3d.loader.G3dModelLoader;
import com.badlogic.gdx.graphics.g3d.loader.ObjLoader;
import com.badlogic.gdx.graphics.glutils.ShaderProgram;
import com.badlogic.gdx.scenes.scene2d.ui.Skin;
import com.badlogic.gdx.utils.Array;
import com.badlogic.gdx.utils.Disposable;
import com.badlogic.gdx.utils.GdxRuntimeException;
import com.badlogic.gdx.utils.I18NBundle;
import com.badlogic.gdx.utils.JsonReader;
import com.badlogic.gdx.utils.Logger;
import com.badlogic.gdx.utils.ObjectIntMap;
import com.badlogic.gdx.utils.ObjectMap;
import com.badlogic.gdx.utils.ObjectSet;
import com.badlogic.gdx.utils.TimeUtils;
import com.badlogic.gdx.utils.UBJsonReader;
import com.badlogic.gdx.utils.async.AsyncExecutor;
import com.badlogic.gdx.utils.async.ThreadUtils;
import com.badlogic.gdx.utils.reflect.ClassReflection;

/** Loads and stores assets like textures, bitmapfonts, tile maps, sounds, music and so on.
 * @author mzechner */
public class AssetManager implements Disposable {
<span class="nc" id="L69">	final ObjectMap&lt;Class, ObjectMap&lt;String, RefCountedContainer&gt;&gt; assets = new ObjectMap();</span>
<span class="nc" id="L70">	final ObjectMap&lt;String, Class&gt; assetTypes = new ObjectMap();</span>
<span class="nc" id="L71">	final ObjectMap&lt;String, Array&lt;String&gt;&gt; assetDependencies = new ObjectMap();</span>
<span class="nc" id="L72">	final ObjectSet&lt;String&gt; injected = new ObjectSet();</span>

<span class="nc" id="L74">	final ObjectMap&lt;Class, ObjectMap&lt;String, AssetLoader&gt;&gt; loaders = new ObjectMap();</span>
<span class="nc" id="L75">	final Array&lt;AssetDescriptor&gt; loadQueue = new Array();</span>
	final AsyncExecutor executor;

<span class="nc" id="L78">	final Stack&lt;AssetLoadingTask&gt; tasks = new Stack();</span>
<span class="nc" id="L79">	AssetErrorListener listener = null;</span>
<span class="nc" id="L80">	int loaded = 0;</span>
<span class="nc" id="L81">	int toLoad = 0;</span>
<span class="nc" id="L82">	int peakTasks = 0;</span>

	final FileHandleResolver resolver;

<span class="nc" id="L86">	Logger log = new Logger(&quot;AssetManager&quot;, Application.LOG_NONE);</span>

	/** Creates a new AssetManager with all default loaders. */
	public AssetManager () {
<span class="nc" id="L90">		this(new InternalFileHandleResolver());</span>
<span class="nc" id="L91">	}</span>

	/** Creates a new AssetManager with all default loaders. */
	public AssetManager (FileHandleResolver resolver) {
<span class="nc" id="L95">		this(resolver, true);</span>
<span class="nc" id="L96">	}</span>

	/** Creates a new AssetManager with optionally all default loaders. If you don't add the default loaders then you do have to
	 * manually add the loaders you need, including any loaders they might depend on.
	 * @param defaultLoaders whether to add the default loaders */
<span class="nc" id="L101">	public AssetManager (FileHandleResolver resolver, boolean defaultLoaders) {</span>
<span class="nc" id="L102">		this.resolver = resolver;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">		if (defaultLoaders) {</span>
<span class="nc" id="L104">			setLoader(BitmapFont.class, new BitmapFontLoader(resolver));</span>
<span class="nc" id="L105">			setLoader(Music.class, new MusicLoader(resolver));</span>
<span class="nc" id="L106">			setLoader(Pixmap.class, new PixmapLoader(resolver));</span>
<span class="nc" id="L107">			setLoader(Sound.class, new SoundLoader(resolver));</span>
<span class="nc" id="L108">			setLoader(TextureAtlas.class, new TextureAtlasLoader(resolver));</span>
<span class="nc" id="L109">			setLoader(Texture.class, new TextureLoader(resolver));</span>
<span class="nc" id="L110">			setLoader(Skin.class, new SkinLoader(resolver));</span>
<span class="nc" id="L111">			setLoader(ParticleEffect.class, new ParticleEffectLoader(resolver));</span>
<span class="nc" id="L112">			setLoader(com.badlogic.gdx.graphics.g3d.particles.ParticleEffect.class,</span>
				new com.badlogic.gdx.graphics.g3d.particles.ParticleEffectLoader(resolver));
<span class="nc" id="L114">			setLoader(PolygonRegion.class, new PolygonRegionLoader(resolver));</span>
<span class="nc" id="L115">			setLoader(I18NBundle.class, new I18NBundleLoader(resolver));</span>
<span class="nc" id="L116">			setLoader(Model.class, &quot;.g3dj&quot;, new G3dModelLoader(new JsonReader(), resolver));</span>
<span class="nc" id="L117">			setLoader(Model.class, &quot;.g3db&quot;, new G3dModelLoader(new UBJsonReader(), resolver));</span>
<span class="nc" id="L118">			setLoader(Model.class, &quot;.obj&quot;, new ObjLoader(resolver));</span>
<span class="nc" id="L119">			setLoader(ShaderProgram.class, new ShaderProgramLoader(resolver));</span>
<span class="nc" id="L120">			setLoader(Cubemap.class, new CubemapLoader(resolver));</span>
		}
<span class="nc" id="L122">		executor = new AsyncExecutor(1, &quot;AssetManager&quot;);</span>
<span class="nc" id="L123">	}</span>

	/** Returns the {@link FileHandleResolver} for which this AssetManager was loaded with.
	 * @return the file handle resolver which this AssetManager uses */
	public FileHandleResolver getFileHandleResolver () {
<span class="nc" id="L128">		return resolver;</span>
	}

	/** @param fileName the asset file name
	 * @return the asset */
	public synchronized &lt;T&gt; T get (String fileName) {
<span class="nc" id="L134">		Class&lt;T&gt; type = assetTypes.get(fileName);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (type == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L136">		ObjectMap&lt;String, RefCountedContainer&gt; assetsByType = assets.get(type);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">		if (assetsByType == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L138">		RefCountedContainer assetContainer = assetsByType.get(fileName);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (assetContainer == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L140">		T asset = assetContainer.getObject(type);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">		if (asset == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L142">		return asset;</span>
	}

	/** @param fileName the asset file name
	 * @param type the asset type
	 * @return the asset */
	public synchronized &lt;T&gt; T get (String fileName, Class&lt;T&gt; type) {
<span class="nc" id="L149">		ObjectMap&lt;String, RefCountedContainer&gt; assetsByType = assets.get(type);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">		if (assetsByType == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L151">		RefCountedContainer assetContainer = assetsByType.get(fileName);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">		if (assetContainer == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L153">		T asset = assetContainer.getObject(type);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">		if (asset == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L155">		return asset;</span>
	}

	/** @param type the asset type
	 * @return all the assets matching the specified type */
	public synchronized &lt;T&gt; Array&lt;T&gt; getAll (Class&lt;T&gt; type, Array&lt;T&gt; out) {
<span class="nc" id="L161">		ObjectMap&lt;String, RefCountedContainer&gt; assetsByType = assets.get(type);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">		if (assetsByType != null) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">			for (ObjectMap.Entry&lt;String, RefCountedContainer&gt; asset : assetsByType.entries()) {</span>
<span class="nc" id="L164">				out.add(asset.value.getObject(type));</span>
<span class="nc" id="L165">			}</span>
		}
<span class="nc" id="L167">		return out;</span>
	}

	/** @param assetDescriptor the asset descriptor
	 * @return the asset */
	public synchronized &lt;T&gt; T get (AssetDescriptor&lt;T&gt; assetDescriptor) {
<span class="nc" id="L173">		return get(assetDescriptor.fileName, assetDescriptor.type);</span>
	}

	/** Returns true if an asset with the specified name is loading, queued to be loaded, or has been loaded. */
	public synchronized boolean contains (String fileName) {
<span class="nc bnc" id="L178" title="All 4 branches missed.">		if (tasks.size() &gt; 0 &amp;&amp; tasks.firstElement().assetDesc.fileName.equals(fileName)) return true;</span>

<span class="nc bnc" id="L180" title="All 2 branches missed.">		for (int i = 0; i &lt; loadQueue.size; i++)</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">			if (loadQueue.get(i).fileName.equals(fileName)) return true;</span>

<span class="nc" id="L183">		return isLoaded(fileName);</span>
	}

	/** Returns true if an asset with the specified name and type is loading, queued to be loaded, or has been loaded. */
	public synchronized boolean contains (String fileName, Class type) {
<span class="nc bnc" id="L188" title="All 2 branches missed.">		if (tasks.size() &gt; 0) {</span>
<span class="nc" id="L189">			AssetDescriptor assetDesc = tasks.firstElement().assetDesc;</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">			if (assetDesc.type == type &amp;&amp; assetDesc.fileName.equals(fileName)) return true;</span>
		}

<span class="nc bnc" id="L193" title="All 2 branches missed.">		for (int i = 0; i &lt; loadQueue.size; i++) {</span>
<span class="nc" id="L194">			AssetDescriptor assetDesc = loadQueue.get(i);</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">			if (assetDesc.type == type &amp;&amp; assetDesc.fileName.equals(fileName)) return true;</span>
		}

<span class="nc" id="L198">		return isLoaded(fileName, type);</span>
	}

	/** Removes the asset and all its dependencies, if they are not used by other assets.
	 * @param fileName the file name */
	public synchronized void unload (String fileName) {
		// check if it's currently processed (and the first element in the stack, thus not a dependency)
		// and cancel if necessary
<span class="nc bnc" id="L206" title="All 2 branches missed.">		if (tasks.size() &gt; 0) {</span>
<span class="nc" id="L207">			AssetLoadingTask currAsset = tasks.firstElement();</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">			if (currAsset.assetDesc.fileName.equals(fileName)) {</span>
<span class="nc" id="L209">				currAsset.cancel = true;</span>
<span class="nc" id="L210">				log.info(&quot;Unload (from tasks): &quot; + fileName);</span>
<span class="nc" id="L211">				return;</span>
			}
		}

		// check if it's in the queue
<span class="nc" id="L216">		int foundIndex = -1;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">		for (int i = 0; i &lt; loadQueue.size; i++) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">			if (loadQueue.get(i).fileName.equals(fileName)) {</span>
<span class="nc" id="L219">				foundIndex = i;</span>
<span class="nc" id="L220">				break;</span>
			}
		}
<span class="nc bnc" id="L223" title="All 2 branches missed.">		if (foundIndex != -1) {</span>
<span class="nc" id="L224">			toLoad--;</span>
<span class="nc" id="L225">			loadQueue.removeIndex(foundIndex);</span>
<span class="nc" id="L226">			log.info(&quot;Unload (from queue): &quot; + fileName);</span>
<span class="nc" id="L227">			return;</span>
		}

		// get the asset and its type
<span class="nc" id="L231">		Class type = assetTypes.get(fileName);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">		if (type == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>

<span class="nc" id="L234">		RefCountedContainer assetRef = assets.get(type).get(fileName);</span>

		// if it is reference counted, decrement ref count and check if we can really get rid of it.
<span class="nc" id="L237">		assetRef.decRefCount();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">		if (assetRef.getRefCount() &lt;= 0) {</span>
<span class="nc" id="L239">			log.info(&quot;Unload (dispose): &quot; + fileName);</span>

			// if it is disposable dispose it
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (assetRef.getObject(Object.class) instanceof Disposable) ((Disposable)assetRef.getObject(Object.class)).dispose();</span>

			// remove the asset from the manager.
<span class="nc" id="L245">			assetTypes.remove(fileName);</span>
<span class="nc" id="L246">			assets.get(type).remove(fileName);</span>
		} else {
<span class="nc" id="L248">			log.info(&quot;Unload (decrement): &quot; + fileName);</span>
		}

		// remove any dependencies (or just decrement their ref count).
<span class="nc" id="L252">		Array&lt;String&gt; dependencies = assetDependencies.get(fileName);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (dependencies != null) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			for (String dependency : dependencies) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">				if (isLoaded(dependency)) unload(dependency);</span>
<span class="nc" id="L256">			}</span>
		}
		// remove dependencies if ref count &lt; 0
<span class="nc bnc" id="L259" title="All 2 branches missed.">		if (assetRef.getRefCount() &lt;= 0) {</span>
<span class="nc" id="L260">			assetDependencies.remove(fileName);</span>
		}
<span class="nc" id="L262">	}</span>

	/** @param asset the asset
	 * @return whether the asset is contained in this manager */
	public synchronized &lt;T&gt; boolean containsAsset (T asset) {
<span class="nc" id="L267">		ObjectMap&lt;String, RefCountedContainer&gt; assetsByType = assets.get(asset.getClass());</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (assetsByType == null) return false;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">		for (String fileName : assetsByType.keys()) {</span>
<span class="nc" id="L270">			T otherAsset = (T)assetsByType.get(fileName).getObject(Object.class);</span>
<span class="nc bnc" id="L271" title="All 4 branches missed.">			if (otherAsset == asset || asset.equals(otherAsset)) return true;</span>
<span class="nc" id="L272">		}</span>
<span class="nc" id="L273">		return false;</span>
	}

	/** @param asset the asset
	 * @return the filename of the asset or null */
	public synchronized &lt;T&gt; String getAssetFileName (T asset) {
<span class="nc bnc" id="L279" title="All 2 branches missed.">		for (Class assetType : assets.keys()) {</span>
<span class="nc" id="L280">			ObjectMap&lt;String, RefCountedContainer&gt; assetsByType = assets.get(assetType);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">			for (String fileName : assetsByType.keys()) {</span>
<span class="nc" id="L282">				T otherAsset = (T)assetsByType.get(fileName).getObject(Object.class);</span>
<span class="nc bnc" id="L283" title="All 4 branches missed.">				if (otherAsset == asset || asset.equals(otherAsset)) return fileName;</span>
<span class="nc" id="L284">			}</span>
<span class="nc" id="L285">		}</span>
<span class="nc" id="L286">		return null;</span>
	}

	/** @param assetDesc the AssetDescriptor of the asset
	 * @return whether the asset is loaded */
	public synchronized boolean isLoaded (AssetDescriptor assetDesc) {
<span class="nc" id="L292">		return isLoaded(assetDesc.fileName);</span>
	}

	/** @param fileName the file name of the asset
	 * @return whether the asset is loaded */
	public synchronized boolean isLoaded (String fileName) {
<span class="nc bnc" id="L298" title="All 2 branches missed.">		if (fileName == null) return false;</span>
<span class="nc" id="L299">		return assetTypes.containsKey(fileName);</span>
	}

	/** @param fileName the file name of the asset
	 * @return whether the asset is loaded */
	public synchronized boolean isLoaded (String fileName, Class type) {
<span class="nc" id="L305">		ObjectMap&lt;String, RefCountedContainer&gt; assetsByType = assets.get(type);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (assetsByType == null) return false;</span>
<span class="nc" id="L307">		RefCountedContainer assetContainer = assetsByType.get(fileName);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">		if (assetContainer == null) return false;</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">		return assetContainer.getObject(type) != null;</span>
	}

	/** Returns the default loader for the given type
	 * @param type The type of the loader to get
	 * @return The loader capable of loading the type, or null if none exists */
	public &lt;T&gt; AssetLoader getLoader (final Class&lt;T&gt; type) {
<span class="nc" id="L316">		return getLoader(type, null);</span>
	}

	/** Returns the loader for the given type and the specified filename. If no loader exists for the specific filename, the
	 * default loader for that type is returned.
	 * @param type The type of the loader to get
	 * @param fileName The filename of the asset to get a loader for, or null to get the default loader
	 * @return The loader capable of loading the type and filename, or null if none exists */
	public &lt;T&gt; AssetLoader getLoader (final Class&lt;T&gt; type, final String fileName) {
<span class="nc" id="L325">		final ObjectMap&lt;String, AssetLoader&gt; loaders = this.loaders.get(type);</span>
<span class="nc bnc" id="L326" title="All 4 branches missed.">		if (loaders == null || loaders.size &lt; 1) return null;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">		if (fileName == null) return loaders.get(&quot;&quot;);</span>
<span class="nc" id="L328">		AssetLoader result = null;</span>
<span class="nc" id="L329">		int l = -1;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">		for (ObjectMap.Entry&lt;String, AssetLoader&gt; entry : loaders.entries()) {</span>
<span class="nc bnc" id="L331" title="All 4 branches missed.">			if (entry.key.length() &gt; l &amp;&amp; fileName.endsWith(entry.key)) {</span>
<span class="nc" id="L332">				result = entry.value;</span>
<span class="nc" id="L333">				l = entry.key.length();</span>
			}
<span class="nc" id="L335">		}</span>
<span class="nc" id="L336">		return result;</span>
	}

	/** Adds the given asset to the loading queue of the AssetManager.
	 * @param fileName the file name (interpretation depends on {@link AssetLoader})
	 * @param type the type of the asset. */
	public synchronized &lt;T&gt; void load (String fileName, Class&lt;T&gt; type) {
<span class="nc" id="L343">		load(fileName, type, null);</span>
<span class="nc" id="L344">	}</span>

	/** Adds the given asset to the loading queue of the AssetManager.
	 * @param fileName the file name (interpretation depends on {@link AssetLoader})
	 * @param type the type of the asset.
	 * @param parameter parameters for the AssetLoader. */
	public synchronized &lt;T&gt; void load (String fileName, Class&lt;T&gt; type, AssetLoaderParameters&lt;T&gt; parameter) {
<span class="nc" id="L351">		AssetLoader loader = getLoader(type, fileName);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">		if (loader == null) throw new GdxRuntimeException(&quot;No loader for type: &quot; + ClassReflection.getSimpleName(type));</span>

		// reset stats
<span class="nc bnc" id="L355" title="All 2 branches missed.">		if (loadQueue.size == 0) {</span>
<span class="nc" id="L356">			loaded = 0;</span>
<span class="nc" id="L357">			toLoad = 0;</span>
<span class="nc" id="L358">			peakTasks = 0;</span>
		}

		// check if an asset with the same name but a different type has already been added.

		// check preload queue
<span class="nc bnc" id="L364" title="All 2 branches missed.">		for (int i = 0; i &lt; loadQueue.size; i++) {</span>
<span class="nc" id="L365">			AssetDescriptor desc = loadQueue.get(i);</span>
<span class="nc bnc" id="L366" title="All 4 branches missed.">			if (desc.fileName.equals(fileName) &amp;&amp; !desc.type.equals(type)) throw new GdxRuntimeException(</span>
				&quot;Asset with name '&quot; + fileName + &quot;' already in preload queue, but has different type (expected: &quot;
<span class="nc" id="L368">					+ ClassReflection.getSimpleName(type) + &quot;, found: &quot; + ClassReflection.getSimpleName(desc.type) + &quot;)&quot;);</span>
		}

		// check task list
<span class="nc bnc" id="L372" title="All 2 branches missed.">		for (int i = 0; i &lt; tasks.size(); i++) {</span>
<span class="nc" id="L373">			AssetDescriptor desc = tasks.get(i).assetDesc;</span>
<span class="nc bnc" id="L374" title="All 4 branches missed.">			if (desc.fileName.equals(fileName) &amp;&amp; !desc.type.equals(type)) throw new GdxRuntimeException(</span>
				&quot;Asset with name '&quot; + fileName + &quot;' already in task list, but has different type (expected: &quot;
<span class="nc" id="L376">					+ ClassReflection.getSimpleName(type) + &quot;, found: &quot; + ClassReflection.getSimpleName(desc.type) + &quot;)&quot;);</span>
		}

		// check loaded assets
<span class="nc" id="L380">		Class otherType = assetTypes.get(fileName);</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">		if (otherType != null &amp;&amp; !otherType.equals(type))</span>
<span class="nc" id="L382">			throw new GdxRuntimeException(&quot;Asset with name '&quot; + fileName + &quot;' already loaded, but has different type (expected: &quot;</span>
<span class="nc" id="L383">				+ ClassReflection.getSimpleName(type) + &quot;, found: &quot; + ClassReflection.getSimpleName(otherType) + &quot;)&quot;);</span>

<span class="nc" id="L385">		toLoad++;</span>
<span class="nc" id="L386">		AssetDescriptor assetDesc = new AssetDescriptor(fileName, type, parameter);</span>
<span class="nc" id="L387">		loadQueue.add(assetDesc);</span>
<span class="nc" id="L388">		log.debug(&quot;Queued: &quot; + assetDesc);</span>
<span class="nc" id="L389">	}</span>

	/** Adds the given asset to the loading queue of the AssetManager.
	 * @param desc the {@link AssetDescriptor} */
	public synchronized void load (AssetDescriptor desc) {
<span class="nc" id="L394">		load(desc.fileName, desc.type, desc.params);</span>
<span class="nc" id="L395">	}</span>

	/** Updates the AssetManager, keeping it loading any assets in the preload queue.
	 * @return true if all loading is finished. */
	public synchronized boolean update () {
		try {
<span class="nc bnc" id="L401" title="All 2 branches missed.">			if (tasks.size() == 0) {</span>
				// loop until we have a new task ready to be processed
<span class="nc bnc" id="L403" title="All 4 branches missed.">				while (loadQueue.size != 0 &amp;&amp; tasks.size() == 0) {</span>
<span class="nc" id="L404">					nextTask();</span>
				}
				// have we not found a task? We are done!
<span class="nc bnc" id="L407" title="All 2 branches missed.">				if (tasks.size() == 0) return true;</span>
			}
<span class="nc bnc" id="L409" title="All 6 branches missed.">			return updateTask() &amp;&amp; loadQueue.size == 0 &amp;&amp; tasks.size() == 0;</span>
<span class="nc" id="L410">		} catch (Throwable t) {</span>
<span class="nc" id="L411">			handleTaskError(t);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">			return loadQueue.size == 0;</span>
		}
	}

	/** Updates the AssetManager continuously for the specified number of milliseconds, yielding the CPU to the loading thread
	 * between updates. This may block for less time if all loading tasks are complete. This may block for more time if the portion
	 * of a single task that happens in the GL thread takes a long time.
	 * @return true if all loading is finished. */
	public boolean update (int millis) {
<span class="nc" id="L421">		long endTime = TimeUtils.millis() + millis;</span>
		while (true) {
<span class="nc" id="L423">			boolean done = update();</span>
<span class="nc bnc" id="L424" title="All 4 branches missed.">			if (done || TimeUtils.millis() &gt; endTime) return done;</span>
<span class="nc" id="L425">			ThreadUtils.yield();</span>
<span class="nc" id="L426">		}</span>
	}

	/** Returns true when all assets are loaded. Can be called from any thread. */
	public synchronized boolean isFinished () {
<span class="nc bnc" id="L431" title="All 4 branches missed.">		return loadQueue.size == 0 &amp;&amp; tasks.size() == 0;</span>
	}

	/** Blocks until all assets are loaded. */
	public void finishLoading () {
<span class="nc" id="L436">		log.debug(&quot;Waiting for loading to complete...&quot;);</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">		while (!update())</span>
<span class="nc" id="L438">			ThreadUtils.yield();</span>
<span class="nc" id="L439">		log.debug(&quot;Loading complete.&quot;);</span>
<span class="nc" id="L440">	}</span>

	/** Blocks until the specified asset is loaded.
	 * @param assetDesc the AssetDescriptor of the asset */
	public &lt;T&gt; T finishLoadingAsset (AssetDescriptor assetDesc) {
<span class="nc" id="L445">		return finishLoadingAsset(assetDesc.fileName);</span>
	}

	/** Blocks until the specified asset is loaded.
	 * @param fileName the file name (interpretation depends on {@link AssetLoader}) */
	public &lt;T&gt; T finishLoadingAsset (String fileName) {
<span class="nc" id="L451">		log.debug(&quot;Waiting for asset to be loaded: &quot; + fileName);</span>
		while (true) {
<span class="nc" id="L453">			synchronized (this) {</span>
<span class="nc" id="L454">				Class&lt;T&gt; type = assetTypes.get(fileName);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">				if (type != null) {</span>
<span class="nc" id="L456">					ObjectMap&lt;String, RefCountedContainer&gt; assetsByType = assets.get(type);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">					if (assetsByType != null) {</span>
<span class="nc" id="L458">						RefCountedContainer assetContainer = assetsByType.get(fileName);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">						if (assetContainer != null) {</span>
<span class="nc" id="L460">							T asset = assetContainer.getObject(type);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">							if (asset != null) {</span>
<span class="nc" id="L462">								log.debug(&quot;Asset loaded: &quot; + fileName);</span>
<span class="nc" id="L463">								return asset;</span>
							}
						}
					}
				}
<span class="nc" id="L468">				update();</span>
<span class="nc" id="L469">			}</span>
<span class="nc" id="L470">			ThreadUtils.yield();</span>
		}
	}

	synchronized void injectDependencies (String parentAssetFilename, Array&lt;AssetDescriptor&gt; dependendAssetDescs) {
<span class="nc" id="L475">		ObjectSet&lt;String&gt; injected = this.injected;</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">		for (AssetDescriptor desc : dependendAssetDescs) {</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">			if (injected.contains(desc.fileName)) continue; // Ignore subsequent dependencies if there are duplicates.</span>
<span class="nc" id="L478">			injected.add(desc.fileName);</span>
<span class="nc" id="L479">			injectDependency(parentAssetFilename, desc);</span>
<span class="nc" id="L480">		}</span>
<span class="nc" id="L481">		injected.clear(32);</span>
<span class="nc" id="L482">	}</span>

	private synchronized void injectDependency (String parentAssetFilename, AssetDescriptor dependendAssetDesc) {
		// add the asset as a dependency of the parent asset
<span class="nc" id="L486">		Array&lt;String&gt; dependencies = assetDependencies.get(parentAssetFilename);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">		if (dependencies == null) {</span>
<span class="nc" id="L488">			dependencies = new Array();</span>
<span class="nc" id="L489">			assetDependencies.put(parentAssetFilename, dependencies);</span>
		}
<span class="nc" id="L491">		dependencies.add(dependendAssetDesc.fileName);</span>

		// if the asset is already loaded, increase its reference count.
<span class="nc bnc" id="L494" title="All 2 branches missed.">		if (isLoaded(dependendAssetDesc.fileName)) {</span>
<span class="nc" id="L495">			log.debug(&quot;Dependency already loaded: &quot; + dependendAssetDesc);</span>
<span class="nc" id="L496">			Class type = assetTypes.get(dependendAssetDesc.fileName);</span>
<span class="nc" id="L497">			RefCountedContainer assetRef = assets.get(type).get(dependendAssetDesc.fileName);</span>
<span class="nc" id="L498">			assetRef.incRefCount();</span>
<span class="nc" id="L499">			incrementRefCountedDependencies(dependendAssetDesc.fileName);</span>
<span class="nc" id="L500">		}</span>
		// else add a new task for the asset.
		else {
<span class="nc" id="L503">			log.info(&quot;Loading dependency: &quot; + dependendAssetDesc);</span>
<span class="nc" id="L504">			addTask(dependendAssetDesc);</span>
		}
<span class="nc" id="L506">	}</span>

	/** Removes a task from the loadQueue and adds it to the task stack. If the asset is already loaded (which can happen if it was
	 * a dependency of a previously loaded asset) its reference count will be increased. */
	private void nextTask () {
<span class="nc" id="L511">		AssetDescriptor assetDesc = loadQueue.removeIndex(0);</span>

		// if the asset not meant to be reloaded and is already loaded, increase its reference count
<span class="nc bnc" id="L514" title="All 2 branches missed.">		if (isLoaded(assetDesc.fileName)) {</span>
<span class="nc" id="L515">			log.debug(&quot;Already loaded: &quot; + assetDesc);</span>
<span class="nc" id="L516">			Class type = assetTypes.get(assetDesc.fileName);</span>
<span class="nc" id="L517">			RefCountedContainer assetRef = assets.get(type).get(assetDesc.fileName);</span>
<span class="nc" id="L518">			assetRef.incRefCount();</span>
<span class="nc" id="L519">			incrementRefCountedDependencies(assetDesc.fileName);</span>
<span class="nc bnc" id="L520" title="All 4 branches missed.">			if (assetDesc.params != null &amp;&amp; assetDesc.params.loadedCallback != null) {</span>
<span class="nc" id="L521">				assetDesc.params.loadedCallback.finishedLoading(this, assetDesc.fileName, assetDesc.type);</span>
			}
<span class="nc" id="L523">			loaded++;</span>
<span class="nc" id="L524">		} else {</span>
			// else add a new task for the asset.
<span class="nc" id="L526">			log.info(&quot;Loading: &quot; + assetDesc);</span>
<span class="nc" id="L527">			addTask(assetDesc);</span>
		}
<span class="nc" id="L529">	}</span>

	/** Adds a {@link AssetLoadingTask} to the task stack for the given asset.
	 * @param assetDesc */
	private void addTask (AssetDescriptor assetDesc) {
<span class="nc" id="L534">		AssetLoader loader = getLoader(assetDesc.type, assetDesc.fileName);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">		if (loader == null) throw new GdxRuntimeException(&quot;No loader for type: &quot; + ClassReflection.getSimpleName(assetDesc.type));</span>
<span class="nc" id="L536">		tasks.push(new AssetLoadingTask(this, assetDesc, loader, executor));</span>
<span class="nc" id="L537">		peakTasks++;</span>
<span class="nc" id="L538">	}</span>

	/** Adds an asset to this AssetManager */
	protected &lt;T&gt; void addAsset (final String fileName, Class&lt;T&gt; type, T asset) {
		// add the asset to the filename lookup
<span class="nc" id="L543">		assetTypes.put(fileName, type);</span>

		// add the asset to the type lookup
<span class="nc" id="L546">		ObjectMap&lt;String, RefCountedContainer&gt; typeToAssets = assets.get(type);</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">		if (typeToAssets == null) {</span>
<span class="nc" id="L548">			typeToAssets = new ObjectMap&lt;String, RefCountedContainer&gt;();</span>
<span class="nc" id="L549">			assets.put(type, typeToAssets);</span>
		}
<span class="nc" id="L551">		typeToAssets.put(fileName, new RefCountedContainer(asset));</span>
<span class="nc" id="L552">	}</span>

	/** Updates the current task on the top of the task stack.
	 * @return true if the asset is loaded or the task was cancelled. */
	private boolean updateTask () {
<span class="nc" id="L557">		AssetLoadingTask task = tasks.peek();</span>

<span class="nc" id="L559">		boolean complete = true;</span>
		try {
<span class="nc bnc" id="L561" title="All 4 branches missed.">			complete = task.cancel || task.update();</span>
<span class="nc" id="L562">		} catch (RuntimeException ex) {</span>
<span class="nc" id="L563">			task.cancel = true;</span>
<span class="nc" id="L564">			taskFailed(task.assetDesc, ex);</span>
<span class="nc" id="L565">		}</span>

		// if the task has been cancelled or has finished loading
<span class="nc bnc" id="L568" title="All 2 branches missed.">		if (complete) {</span>
			// increase the number of loaded assets and pop the task from the stack
<span class="nc bnc" id="L570" title="All 2 branches missed.">			if (tasks.size() == 1) {</span>
<span class="nc" id="L571">				loaded++;</span>
<span class="nc" id="L572">				peakTasks = 0;</span>
			}
<span class="nc" id="L574">			tasks.pop();</span>

<span class="nc bnc" id="L576" title="All 2 branches missed.">			if (task.cancel) return true;</span>

<span class="nc" id="L578">			addAsset(task.assetDesc.fileName, task.assetDesc.type, task.getAsset());</span>

			// otherwise, if a listener was found in the parameter invoke it
<span class="nc bnc" id="L581" title="All 4 branches missed.">			if (task.assetDesc.params != null &amp;&amp; task.assetDesc.params.loadedCallback != null) {</span>
<span class="nc" id="L582">				task.assetDesc.params.loadedCallback.finishedLoading(this, task.assetDesc.fileName, task.assetDesc.type);</span>
			}

<span class="nc" id="L585">			long endTime = TimeUtils.nanoTime();</span>
<span class="nc" id="L586">			log.debug(&quot;Loaded: &quot; + (endTime - task.startTime) / 1000000f + &quot;ms &quot; + task.assetDesc);</span>

<span class="nc" id="L588">			return true;</span>
		}
<span class="nc" id="L590">		return false;</span>
	}

	/** Called when a task throws an exception during loading. The default implementation rethrows the exception. A subclass may
	 * supress the default implementation when loading assets where loading failure is recoverable. */
	protected void taskFailed (AssetDescriptor assetDesc, RuntimeException ex) {
<span class="nc" id="L596">		throw ex;</span>
	}

	private void incrementRefCountedDependencies (String parent) {
<span class="nc" id="L600">		Array&lt;String&gt; dependencies = assetDependencies.get(parent);</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">		if (dependencies == null) return;</span>

<span class="nc bnc" id="L603" title="All 2 branches missed.">		for (String dependency : dependencies) {</span>
<span class="nc" id="L604">			Class type = assetTypes.get(dependency);</span>
<span class="nc" id="L605">			RefCountedContainer assetRef = assets.get(type).get(dependency);</span>
<span class="nc" id="L606">			assetRef.incRefCount();</span>
<span class="nc" id="L607">			incrementRefCountedDependencies(dependency);</span>
<span class="nc" id="L608">		}</span>
<span class="nc" id="L609">	}</span>

	/** Handles a runtime/loading error in {@link #update()} by optionally invoking the {@link AssetErrorListener}.
	 * @param t */
	private void handleTaskError (Throwable t) {
<span class="nc" id="L614">		log.error(&quot;Error loading asset.&quot;, t);</span>

<span class="nc bnc" id="L616" title="All 2 branches missed.">		if (tasks.isEmpty()) throw new GdxRuntimeException(t);</span>

		// pop the faulty task from the stack
<span class="nc" id="L619">		AssetLoadingTask task = tasks.pop();</span>
<span class="nc" id="L620">		AssetDescriptor assetDesc = task.assetDesc;</span>

		// remove all dependencies
<span class="nc bnc" id="L623" title="All 4 branches missed.">		if (task.dependenciesLoaded &amp;&amp; task.dependencies != null) {</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">			for (AssetDescriptor desc : task.dependencies) {</span>
<span class="nc" id="L625">				unload(desc.fileName);</span>
<span class="nc" id="L626">			}</span>
		}

		// clear the rest of the stack
<span class="nc" id="L630">		tasks.clear();</span>

		// inform the listener that something bad happened
<span class="nc bnc" id="L633" title="All 2 branches missed.">		if (listener != null) {</span>
<span class="nc" id="L634">			listener.error(assetDesc, t);</span>
		} else {
<span class="nc" id="L636">			throw new GdxRuntimeException(t);</span>
		}
<span class="nc" id="L638">	}</span>

	/** Sets a new {@link AssetLoader} for the given type.
	 * @param type the type of the asset
	 * @param loader the loader */
	public synchronized &lt;T, P extends AssetLoaderParameters&lt;T&gt;&gt; void setLoader (Class&lt;T&gt; type, AssetLoader&lt;T, P&gt; loader) {
<span class="nc" id="L644">		setLoader(type, null, loader);</span>
<span class="nc" id="L645">	}</span>

	/** Sets a new {@link AssetLoader} for the given type.
	 * @param type the type of the asset
	 * @param suffix the suffix the filename must have for this loader to be used or null to specify the default loader.
	 * @param loader the loader */
	public synchronized &lt;T, P extends AssetLoaderParameters&lt;T&gt;&gt; void setLoader (Class&lt;T&gt; type, String suffix,
		AssetLoader&lt;T, P&gt; loader) {
<span class="nc bnc" id="L653" title="All 2 branches missed.">		if (type == null) throw new IllegalArgumentException(&quot;type cannot be null.&quot;);</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">		if (loader == null) throw new IllegalArgumentException(&quot;loader cannot be null.&quot;);</span>
<span class="nc" id="L655">		log.debug(&quot;Loader set: &quot; + ClassReflection.getSimpleName(type) + &quot; -&gt; &quot; + ClassReflection.getSimpleName(loader.getClass()));</span>
<span class="nc" id="L656">		ObjectMap&lt;String, AssetLoader&gt; loaders = this.loaders.get(type);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">		if (loaders == null) this.loaders.put(type, loaders = new ObjectMap&lt;String, AssetLoader&gt;());</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">		loaders.put(suffix == null ? &quot;&quot; : suffix, loader);</span>
<span class="nc" id="L659">	}</span>

	/** @return the number of loaded assets */
	public synchronized int getLoadedAssets () {
<span class="nc" id="L663">		return assetTypes.size;</span>
	}

	/** @return the number of currently queued assets */
	public synchronized int getQueuedAssets () {
<span class="nc" id="L668">		return loadQueue.size + tasks.size();</span>
	}

	/** @return the progress in percent of completion. */
	public synchronized float getProgress () {
<span class="nc bnc" id="L673" title="All 2 branches missed.">		if (toLoad == 0) return 1;</span>
<span class="nc" id="L674">		float fractionalLoaded = (float)loaded;</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">		if (peakTasks &gt; 0) {</span>
<span class="nc" id="L676">			fractionalLoaded += ((peakTasks - tasks.size()) / (float)peakTasks);</span>
		}
<span class="nc" id="L678">		return Math.min(1, fractionalLoaded / (float)toLoad);</span>
	}

	/** Sets an {@link AssetErrorListener} to be invoked in case loading an asset failed.
	 * @param listener the listener or null */
	public synchronized void setErrorListener (AssetErrorListener listener) {
<span class="nc" id="L684">		this.listener = listener;</span>
<span class="nc" id="L685">	}</span>

	/** Disposes all assets in the manager and stops all asynchronous loading. */
	@Override
	public synchronized void dispose () {
<span class="nc" id="L690">		log.debug(&quot;Disposing.&quot;);</span>
<span class="nc" id="L691">		clear();</span>
<span class="nc" id="L692">		executor.dispose();</span>
<span class="nc" id="L693">	}</span>

	/** Clears and disposes all assets and the preloading queue. */
	public synchronized void clear () {
<span class="nc" id="L697">		loadQueue.clear();</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">		while (!update())</span>
<span class="nc" id="L699">			;</span>

<span class="nc" id="L701">		ObjectIntMap&lt;String&gt; dependencyCount = new ObjectIntMap&lt;String&gt;();</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">		while (assetTypes.size &gt; 0) {</span>
			// for each asset, figure out how often it was referenced
<span class="nc" id="L704">			dependencyCount.clear();</span>
<span class="nc" id="L705">			Array&lt;String&gt; assets = assetTypes.keys().toArray();</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">			for (String asset : assets) {</span>
<span class="nc" id="L707">				dependencyCount.put(asset, 0);</span>
<span class="nc" id="L708">			}</span>

<span class="nc bnc" id="L710" title="All 2 branches missed.">			for (String asset : assets) {</span>
<span class="nc" id="L711">				Array&lt;String&gt; dependencies = assetDependencies.get(asset);</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">				if (dependencies == null) continue;</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">				for (String dependency : dependencies) {</span>
<span class="nc" id="L714">					int count = dependencyCount.get(dependency, 0);</span>
<span class="nc" id="L715">					count++;</span>
<span class="nc" id="L716">					dependencyCount.put(dependency, count);</span>
<span class="nc" id="L717">				}</span>
<span class="nc" id="L718">			}</span>

			// only dispose of assets that are root assets (not referenced)
<span class="nc bnc" id="L721" title="All 2 branches missed.">			for (String asset : assets) {</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">				if (dependencyCount.get(asset, 0) == 0) {</span>
<span class="nc" id="L723">					unload(asset);</span>
				}
<span class="nc" id="L725">			}</span>
<span class="nc" id="L726">		}</span>

<span class="nc" id="L728">		this.assets.clear();</span>
<span class="nc" id="L729">		this.assetTypes.clear();</span>
<span class="nc" id="L730">		this.assetDependencies.clear();</span>
<span class="nc" id="L731">		this.loaded = 0;</span>
<span class="nc" id="L732">		this.toLoad = 0;</span>
<span class="nc" id="L733">		this.peakTasks = 0;</span>
<span class="nc" id="L734">		this.loadQueue.clear();</span>
<span class="nc" id="L735">		this.tasks.clear();</span>
<span class="nc" id="L736">	}</span>

	/** @return the {@link Logger} used by the {@link AssetManager} */
	public Logger getLogger () {
<span class="nc" id="L740">		return log;</span>
	}

	public void setLogger (Logger logger) {
<span class="nc" id="L744">		log = logger;</span>
<span class="nc" id="L745">	}</span>

	/** Returns the reference count of an asset.
	 * @param fileName */
	public synchronized int getReferenceCount (String fileName) {
<span class="nc" id="L750">		Class type = assetTypes.get(fileName);</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">		if (type == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L752">		return assets.get(type).get(fileName).getRefCount();</span>
	}

	/** Sets the reference count of an asset.
	 * @param fileName */
	public synchronized void setReferenceCount (String fileName, int refCount) {
<span class="nc" id="L758">		Class type = assetTypes.get(fileName);</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">		if (type == null) throw new GdxRuntimeException(&quot;Asset not loaded: &quot; + fileName);</span>
<span class="nc" id="L760">		assets.get(type).get(fileName).setRefCount(refCount);</span>
<span class="nc" id="L761">	}</span>

	/** @return a string containing ref count and dependency information for all assets. */
	public synchronized String getDiagnostics () {
<span class="nc" id="L765">		StringBuilder sb = new StringBuilder(256);</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">		for (String fileName : assetTypes.keys()) {</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">			if (sb.length() &gt; 0) sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L768">			sb.append(fileName);</span>
<span class="nc" id="L769">			sb.append(&quot;, &quot;);</span>

<span class="nc" id="L771">			Class type = assetTypes.get(fileName);</span>
<span class="nc" id="L772">			RefCountedContainer assetRef = assets.get(type).get(fileName);</span>
<span class="nc" id="L773">			Array&lt;String&gt; dependencies = assetDependencies.get(fileName);</span>

<span class="nc" id="L775">			sb.append(ClassReflection.getSimpleName(type));</span>

<span class="nc" id="L777">			sb.append(&quot;, refs: &quot;);</span>
<span class="nc" id="L778">			sb.append(assetRef.getRefCount());</span>

<span class="nc bnc" id="L780" title="All 2 branches missed.">			if (dependencies != null) {</span>
<span class="nc" id="L781">				sb.append(&quot;, deps: [&quot;);</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">				for (String dep : dependencies) {</span>
<span class="nc" id="L783">					sb.append(dep);</span>
<span class="nc" id="L784">					sb.append(&quot;,&quot;);</span>
<span class="nc" id="L785">				}</span>
<span class="nc" id="L786">				sb.append(&quot;]&quot;);</span>
			}
<span class="nc" id="L788">		}</span>
<span class="nc" id="L789">		return sb.toString();</span>
	}

	/** @return the file names of all loaded assets. */
	public synchronized Array&lt;String&gt; getAssetNames () {
<span class="nc" id="L794">		return assetTypes.keys().toArray();</span>
	}

	/** @return the dependencies of an asset or null if the asset has no dependencies. */
	public synchronized Array&lt;String&gt; getDependencies (String fileName) {
<span class="nc" id="L799">		return assetDependencies.get(fileName);</span>
	}

	/** @return the type of a loaded asset. */
	public synchronized Class getAssetType (String fileName) {
<span class="nc" id="L804">		return assetTypes.get(fileName);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>